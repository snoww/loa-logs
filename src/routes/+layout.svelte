<script lang="ts">
    import "@fontsource-variable/inter";
    import "@fontsource-variable/jetbrains-mono";
    import "../app.css";
    import { onMount, type Snippet } from "svelte";
    import { listen, type UnlistenFn } from "@tauri-apps/api/event";
    import { navigating } from "$app/stores";
    import NProgress from "nprogress";
    import "nprogress/nprogress.css";
    import { goto, invalidateAll } from "$app/navigation";
    import { settings, updateSettings } from "$lib/utils/settings";
    import { appWindow } from "@tauri-apps/api/window";
    import { checkUpdate } from "@tauri-apps/api/updater";
    import { invoke } from "@tauri-apps/api/tauri";
    import UpdateAvailable from "$lib/components/shared/UpdateAvailable.svelte";

    let { children }: { children: Snippet } = $props();

    NProgress.configure({
        template: '<div class="bar !bg-gray-500" role="bar"><div class="peg !shadow-gray-500"></div></div>'
    });

    onMount(() => {
        let unsubscribe = navigating.subscribe((navigating) => {
            if (navigating) NProgress.start();
            else NProgress.done();
        });

        let events: Set<UnlistenFn> = new Set();

        if (location.pathname !== "/") {
            (async () => {
                await checkForUpdate();

                if ($updateSettings.available) {
                    await showWindow();
                }

                let encounterUpdateEvent = await listen("show-latest-encounter", async (event) => {
                    await goto("/logs/encounter/" + event.payload);
                    await showWindow();
                });
                let openUrlEvent = await listen("redirect-url", async (event) => {
                    await invalidateAll();
                    await goto("/" + event.payload);
                    await showWindow();
                });

                events.add(encounterUpdateEvent);
                events.add(openUrlEvent);

                setInterval(checkForUpdate, 60 * 15 * 1000);
            })();
        }

        return () => {
            unsubscribe();
            events.forEach((unlisten) => unlisten());
        };
    });

    async function showWindow() {
        await appWindow.show();
        await appWindow.unminimize();
        await appWindow.setFocus();
    }

    async function checkForUpdate() {
        try {
            const { shouldUpdate, manifest } = await checkUpdate();
            if (shouldUpdate) {
                $updateSettings.available = true;
                const oldManifest = $updateSettings.manifest;
                $updateSettings.manifest = manifest;
                if (oldManifest?.version !== $updateSettings.manifest?.version) {
                    $updateSettings.dismissed = false;
                }
                if (manifest?.version.includes("2024")) {
                    $updateSettings.isNotice = true;
                } else {
                    $updateSettings.isNotice = false;
                }
            }
        } catch (e) {
            await invoke("write_log", { message: e });
        }
    }

    $effect(() => {
        if (location.pathname !== "/") {
            if ($settings.general.logScale === "1") {
                document.documentElement.style.setProperty("font-size", "medium");
            } else if ($settings.general.logScale === "2") {
                document.documentElement.style.setProperty("font-size", "large");
            } else if ($settings.general.logScale === "3") {
                document.documentElement.style.setProperty("font-size", "x-large");
            } else if ($settings.general.logScale === "0") {
                document.documentElement.style.setProperty("font-size", "small");
            }
        } else {
            if ($settings.general.scale === "1") {
                document.documentElement.style.setProperty("font-size", "medium");
            } else if ($settings.general.scale === "2") {
                document.documentElement.style.setProperty("font-size", "large");
            } else if ($settings.general.scale === "3") {
                document.documentElement.style.setProperty("font-size", "x-large");
            } else if ($settings.general.scale === "0") {
                document.documentElement.style.setProperty("font-size", "small");
            }
        }
    });
</script>

<div class={$settings.general.accentColor}>
    {@render children()}
    {#if location.pathname !== "/"}
        <UpdateAvailable />
    {/if}
</div>
